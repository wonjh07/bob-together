# AI Changelog (Rolling)

## 2026-02-13
- Added profile group-management page (`/dashboard/profile/groups`) with shared `PlainTopNav`, card list UI, and infinite scroll.
- Added group-management card interactions: per-card `⋮` dropdown and real `그룹 탈퇴` action handling.
- Added `leaveGroupAction` and `listMyGroupsWithStatsAction`, plus group query key/options for management pagination.
- Added migration `20260213152000_group_manage_list_and_leave_policy.sql` for `list_my_groups_with_stats` RPC and `group_members_delete_self` policy.
- Added `getEffectiveAppointmentStatus` utility and applied derived `ended` status rendering for dashboard appointment cards.
- Updated appointment detail action UI to treat `ended`/`canceled` as non-participation states for non-owners (hide join/leave), preparing status simplification.
- Removed owner-side `확정하기/확정 취소` controls from appointment detail action area; now owner flow is `초대하기/취소하기` or `약속 활성화하기(취소 상태)`.
- Added server-side guards for appointment mutations: block `join/leave` on canceled or time-ended appointments, and block status changes on time-ended appointments.
- Replaced profile review waitlist dummy cards with real `listReviewableAppointmentsAction` data (ended + non-canceled appointments only) and linked each card to review entry route.
- Normalized appointment status exposure by collapsing persisted `confirmed` into `pending` at action/UI layer and removed `confirmed` badge/response typing from client-facing contracts.
- Added migration `20260213174000_remove_confirmed_from_appointment_status.sql` to normalize existing `confirmed` rows to `pending`, shrink `appointment_status` enum (`pending`,`canceled`), and recreate dependent appointment RPCs.
- Moved appointment cancel entry point from detail action area to appointment edit page (`약속 취소하기` button), while keeping detail page focused on invitation/activation controls.
- Moved `약속 활성화하기` entry point from detail page to appointment edit page, so both cancel/activate status transitions are handled in a single edit screen.
- Switched appointment edit status-button visibility source from local initial props to React Query detail cache (`appointmentKeys.detail`) to prevent stale status after cancel/activate round-trips.

## 2026-02-12
- Reworked `CACHE_OWNERSHIP.md` from high-level notes into a file-level ownership/invalidation matrix.
- Added explicit query-key standard, screen ownership table, mutation invalidation matrix, and operational checklist.
- Migrated appointment detail page to Query ownership with server prefetch + hydration (`AppointmentDetailClient`).
- Added detail/comment query keys (`appointmentKeys.detail`, `appointmentKeys.comments`) and matching query options.
- Removed `router.refresh()` calls from appointment detail status/join/leave actions and rely on query invalidation for sync.
- Updated appointment comment create/update/delete UI flow to sync `appointmentKeys.comments(...)` cache and invalidate `appointmentKeys.all` on count-changing mutations.
- Updated appointment edit completion flow to invalidate `appointmentKeys.all` and removed `router.refresh()` dependency.
- Added `appointmentKeys.listRoot/searchRoot` and `invalidateAppointmentQueries` helpers to avoid broad `appointmentKeys.all` invalidation.
- Narrowed detail/edit/comment invalidation to target detail/comments and collection roots instead of invalidating all appointment queries.
- Removed `revalidatePath` from `updateAppointmentStatusAction` to align with Query-owned synchronization.
- Removed comment-state duplication in `AppointmentCommentsSection` and switched it to direct Query subscription (`useQuery`) + cache updates via `setQueryData`.

## 2026-02-11
- Added `CACHE_OWNERSHIP.md` to document current Server/Client cache ownership and invalidation rules.
- Linked `CACHE_OWNERSHIP.md` from `INDEX.md` and referenced it in `DATA_STATE_STRATEGY.md`.
- Added owner-only comment menu UI (`⋮`) and dropdown actions (`댓글 수정`, `댓글 삭제`) on appointment detail comments.
- Added in-place comment edit flow (same input behavior as create: `Enter` submit, `Shift+Enter` newline, 200-char limit).
- Added `updateAppointmentCommentAction` and `deleteAppointmentCommentAction`.
- Added action tests: `updateAppointmentCommentAction.test.ts`, `deleteAppointmentCommentAction.test.ts`.
- Added `SUPABASE.md` for practical Supabase guardrails, checklists, and command-style prompts.
- Removed admin-client dependency from `getUserData` and switched users-table read to authenticated server client + RLS.
- Removed admin-client dependency from `updateProfileAction` and switched users-table update to authenticated server client + RLS.
- Removed admin-client dependency from `deleteProfileImageAction` and switched users/storage delete path to authenticated server client + RLS.
- Removed admin-client dependency from `uploadProfileImageAction` and switched users/storage upload path to authenticated server client + RLS.
- Removed admin-client dependency from `getAppointmentMembersAction` and switched member-list fetch to authenticated server client + RLS.
- Replaced admin-based email duplication check with RPC in `checkEmailExists` (`validation.ts`).
- Added `updateProfileAction.test.ts` with success/failure coverage for auth/user-row/auth-metadata update paths.
- Added `20260211201000_users_update_self_rls_policy.sql` migration (`users_update_self` policy + users update grant).
- Added `20260211203000_profile_images_storage_rls_policies.sql` migration for own-object access in `profile-images` bucket.
- Added `20260211210000_appointment_members_select_group_member.sql` migration to allow group members to read appointment member lists.
- Added `20260211213000_check_email_exists_rpc.sql` migration for pre-login email duplication checks.
- Updated appointment comment input to auto-resize textarea height on multiline input.
- Updated appointment comment UX: max length reduced to 200 chars, textarea input enabled, `Enter` submit and `Shift+Enter` line break behavior added.
- Added `appointment_comments` RLS migration (`20260211193000_appointment_comments_rls_policies.sql`).
- Switched comment read/write actions to authenticated client path (removed admin-client dependency for comments).
- Changed appointment comment permission from appointment-member-only to appointment-access-based (group member), allowing non-participant viewers to comment.
- Added appointment detail comment feature (list + create) in `/dashboard/appointments/[appointmentId]`.
- Added `getAppointmentCommentsAction` and `createAppointmentCommentAction`.
- Added comment input UI and comment card list (right-side dots button UI only).
- Added appointment edit submit flow for `/dashboard/appointments/[appointmentId]/edit`.
- Added editable title/date/time fields and connected `완료` button to real save.
- Added `updateAppointmentAction` with owner permission check and time validation.
- Added place resolution on edit save (existing `place_id` reuse or `kakao_id` upsert fallback).
- Added `updateAppointmentAction.test.ts` for invalid-time validation.
- Preserved edit draft query params (`title/date/startTime/endTime`) across place-search roundtrip.
- Included `placeKakaoId` in place-search selection query for update save compatibility.

## 2026-02-10
- Added appointment edit route `/dashboard/appointments/[appointmentId]/edit` UI with place-change CTA.
- Added appointment edit place-search route `/dashboard/appointments/[appointmentId]/edit/place` using create flow place search pattern.
- Added appointment members page at `/dashboard/appointments/[appointmentId]/members`.
- Added `getAppointmentMembersAction` and connected detail `멤버보기` button routing.
- Added appointment detail status actions (`확정`, `확정 취소`, `취소`, `활성화`) with toast feedback.
- Added `updateAppointmentStatusAction` and wired detail page CTA state rendering.
- Wired detail page `초대하기` button to appointment invitation page with query params.
- Added real dashboard search for groups/appointments by title with TanStack Query.
- Replaced search dummy data with server actions and cursor-based infinite scroll.
- Added `searchGroupsWithCountAction` and `searchAppointmentsByTitleAction`.
- Added Supabase RPC migration (`search_groups_with_count`, `search_appointments_with_count`) to return accurate member counts.
- Added query key/options for search and connected them to search result components.
- Added appointment detail page UI at `/dashboard/appointments/[appointmentId]` with detail top nav (`뒤로가기/수정`) and Kakao map preview.
- Added `getAppointmentDetailAction` and detail RPC (`get_appointment_detail_with_count`) for appointment/place/creator/member-count payload.

## 2026-02-06
- Moved dashboard route groups to `src/app/dashboard/(nav)` and `src/app/dashboard/(plain)`.
- Relocated nav components under `src/app/dashboard/_components/nav` and shared dashboard components under `src/app/dashboard/_components`.
- Removed legacy `(app)` and `(app-plain)` route groups.
- Reworked CODEMAP into a “start-here” navigation map and trimmed routes from it.
- Reorganized FLOWS to be the single source of route-to-file mappings.
- Added DESIGN_GUARDRAILS.md to centralize state/props/provider/query design rules.
- Linked AGENTS to the new guardrails doc.
- Refined DESIGN_GUARDRAILS.md into a decision checklist with query/provider/hydration guidance.
- Renamed DESIGN_GUARDRAILS.md to “Data Fetching & State Strategy” and expanded practical guardrails.
- Slimmed AGENTS.md to workflow + doc references and moved conventions into PROJECT.md.
- Standardized ERRORS_AND_LESSONS.md entries to a short template format.
- Updated DECISIONS.md to a short template and normalized the existing entry.
- Added a Korean decision entry for the dashboard route group restructure.
- Translated the existing DECISIONS.md entry into Korean for consistency.
- Added a workflow rule in AGENTS.md to record structural decisions in DECISIONS.md.
- Added CSS property order guidance to STYLE_GUIDE.md.
- Added practical CSS guidelines for layout-first, container responsibilities, and text overflow handling.
- Clarified DESIGN_SCAN.md wording for image usage, pixel scale, and file placement.
- Disabled Kakao map interaction in the appointment confirm step via a preview option.
- Added a horizontal `ReviewsWaitList` dummy card component to the profile page.
- Updated `ReviewsWaitList` cards to include appointment title and explicit rating count text.
- Added profile edit UI with image preview/upload, plus user profile update actions and DB migration for `users.profile_image`.
- Updated profile image upload flow to keep only the latest image by deleting the previous storage object after successful replacement.
- Changed profile data source to prefer `users` table in `getUserData` (metadata fallback kept).
- Adjusted profile image delete flow to update DB first, then remove storage file.
- Changed profile image metadata sync to best-effort in upload/delete actions.
- Improved profile edit submit flow to save text fields first, then apply image upload/delete.
- Added partial-success error messaging for profile image operations after text save.
- Fixed profile edit image control accessibility by removing nested button structure.
- Expanded `getUserData` tests to cover users-table-priority and metadata-fallback behavior.
- Added `uploadProfileImageAction`/`deleteProfileImageAction` tests for key edge cases (missing file, metadata sync failure, storage remove failure).
- Added profile-image URL parse-failure test cases for upload/delete actions.
- Split `src/actions/user.ts` into `src/actions/user/*` (index + per-action files + shared helpers/types).
- Split `src/actions/user.test.ts` into per-action test files under `src/actions/user/`.
- Split `src/actions/group.ts` into `src/actions/group/*` (index + per-action files + shared helpers/types) and removed the legacy single file.
- Split `src/actions/group.test.ts` into per-action test files under `src/actions/group/`.
- Added `src/actions/group/_testUtils.ts` and deduplicated repeated Supabase mock helpers across group action tests.
- Split `src/actions/appointment.ts` into `src/actions/appointment/*` (index + per-action files + shared helpers/types) and removed the legacy single file.
- Split `src/actions/appointment.test.ts` into `src/actions/appointment/createAppointmentAction.test.ts`.
- Split `src/actions/auth.ts` into `src/actions/auth/*` (index + per-action files + shared helpers/types) and removed the legacy single file.
- Split `src/actions/auth.test.ts` into per-action test files under `src/actions/auth/`.
- Centralized selected-group cookie read/write logic in `src/libs/server/groupSelectionCookie.ts` and made action/server readers reuse it.
- Consolidated `groupSelection` read/write into `src/libs/server/groupSelection.ts` and removed split helper/action files.

## 2026-02-04
- Added a sliding indicator animation to the search type toggle and aligned segments to equal widths.
- Documented DESIGN_SCAN.md usage in AGENTS.md and added it to the AI docs index.
- Added a search input component to the dashboard search page based on the design scan image.
- Removed mobile tap highlight and default button chrome from the search type toggle.
- Tuned the search toggle indicator transition to a springy cubic-bezier easing.
- Added appointment search result card/list components with dummy data for the search page.
- Added the missing appointment title line to the search result card.
- Added group search result card/list components with dummy data on the search page.
- Added a title line to the group search result cards.
- Wired the search type toggle to switch between appointment and group results via a client wrapper.
- Added TanStack Query provider and migrated the appointment list to useInfiniteQuery (client-only).
- Fixed React Query type errors and lint ordering warnings after the migration.
- Added SSR prefetch + HydrationBoundary for the dashboard appointment list.
-- Reverted server QueryClient util extraction (inlined again in dashboard page).
- Added shared appointment query keys utility for SSR/client consistency.
- Documented always considering type-check/lint in AGENTS.md and fixed query key typing.
- Extracted client QueryClient defaults into a utility and wired Providers to use it.
- Shared appointment list query options between SSR prefetch and client list.
- Added group query keys and group query options utilities.
- Switched dashboard group dropdown to useQuery and slimmed GroupProvider to selection state only.
- Prefetched group list data on the dashboard to hydrate the group dropdown.
- Switched create appointment flow to use group queries via the client component and synced provider state.
- Standardized create appointment step components to use `import * as styles` and documented the rule in STYLE_GUIDE.
- Refactored appointment creation to store draft data in provider and move step-specific state/handlers into each step.
- Migrated appointment create flow to react-hook-form with FormProvider/useFormContext and step-level validation.
- Centralized appointment schema usage by reusing `src/schemas/appointment.ts` in the create form types.
- Added Zod schema validation for appointment create form and wired zodResolver.
- Standardized dashboard css imports to `import * as styles` within `(app)/dashboard`.
- Inlined create-appointment group loading into the create page and removed the route layout wrapper.
- Renamed the appointment create client component to `MultiStepFormClient`.
- Split appointment create schema into a base schema and derived UI/server schemas.
- Moved time-order validation to UI-only schema and left server checks in action logic.
- Removed the duplicate PlaceStep next button to prevent skipping validation.
- Added loading/empty-state handling for group selection in the create flow.
- Limited ConfirmStep subscriptions to needed fields with useWatch.
- Added profile summary and quick-link components to the dashboard profile page.
- Set appointment create default date/time to now and +1 hour.
- Moved default date/time helper to `src/utils` and ensured DateTimeStep applies defaults.

## 2026-02-03
- Added dashboard appointment list with GroupContext for shared group selection state.
- Created `listAppointmentsAction` with cursor-based pagination, period/type filters.
- Added `useInfiniteScroll` hook with IntersectionObserver for infinite scroll.
- Created filter components: `PeriodFilter` (dropdown), `TypeFilter` (chip buttons).
- Created `AppointmentCard` with status badges (confirmed/pending/canceled), participant info, edit button.
- Created `AppointmentList` integrating filters, cards, and infinite scroll.
- Refactored `TopNav` to use `useGroupContext()` instead of props.
- Wrapped app layout children with `GroupProvider` for shared group state.
- Updated dashboard page to render `AppointmentList` component.
- Switched onboarding back button control to a route-based client gate and removed onboarding layout context usage.
- Converted onboarding group completion pages to Server Components using `searchParams` props.
- Split onboarding login into a Server page with a client `LoginForm` component to reduce `use client` scope.
- Split onboarding signup into a Server page with a client `SignupForm` component and moved root error styling to CSS.
- Split onboarding group create into a Server page with a client `GroupCreateForm` component.
- Split onboarding group invitation into a Server page with a client `GroupInvitationClient` for search/invite interactions.
- Split onboarding group join into a Server page with a client `GroupJoinClient` for search and navigation interactions.
- Split onboarding group join confirm into a Server page with a client `GroupJoinConfirmClient`, moving the join action to the client and resolving group name on the server when possible.
- Added `FormError` UI component and replaced the signup root error inline style with the shared component.
- Added `getActionErrorMessage` utility and adopted it across onboarding client actions for consistent error handling.
- Added group selection cookie actions to persist the selected group across navigations.
- Updated `GroupProvider` to persist selected group changes into cookies.
- Updated app layout to initialize group selection from the persisted cookie when available.
- Updated appointment create layout to initialize group selection from the persisted cookie when available.
- Guarded appointment creation to require a selected group.
- Moved cookie read helper to a server-only module to avoid client import issues.
- Removed group dropdown usage from `TopNav` in preparation for moving group selection to the dashboard page.
- Moved `GroupProvider` and group list initialization to the dashboard page.
- Added dashboard header with group dropdown for group selection.
- Added group selection step with a new dropdown in appointment create flow.
- Added new AI docs: DECISIONS, CODEMAP, ACTIONS, ERRORS_AND_LESSONS and registered them in INDEX.
- Removed outdated CONTEXT_SESSION.md and unlinked it from INDEX.
- Trimmed GROUP_FLOW.md to focus on routes, actions, and shared styles.
- Trimmed and updated APPOINTMENTS_FLOW.md to reflect current entry points and routes.
- Updated CONTEXT_ROUTES.md to match current route structure and appointment step locations.
- Merged CONTEXT_TROUBLESHOOTING.md into ERRORS_AND_LESSONS.md and removed the old file.
- Merged CONTEXT_ROUTES.md into CODEMAP.md and removed the standalone routes doc.
- Centralized action lists in ACTIONS.md and removed action sections from flow docs.
- Recorded recent decisions in DECISIONS.md (without impact/verification sections).
- Renamed context docs: PROJECT.md, GROUP_FLOW.md, APPOINTMENTS_FLOW.md, KAKAO_INTEGRATION.md, DB_RLS.md.
- Merged GROUP_FLOW.md and APPOINTMENTS_FLOW.md into FLOWS.md and removed the originals.
- Removed unused TEMPLATE.md and TEMPLATE_EN.md from ai_docs.
- Removed unused scripts/update_ai_docs.sh.
- Removed getActionErrorMessage utility and restored direct result handling.
- Split appointment create page into a Server page with a client AppointmentCreateClient.
- Extracted current location logic into `useCurrentLocation` hook for appointment creation.
- Extracted place search logic into `usePlaceSearch` hook for appointment creation.
- Moved group selection cookie helper to `src/libs/server` and updated imports.
- Added search page header toggle UI based on the design scan.
- Added active toggle state and transition animation for the search type switch.
- Split appointment invitation page into a Server page and a client `AppointmentInvitationClient`.
- Removed unused `comment_count` from `get_appointment_detail_with_count` RPC payload and aligned detail action typing to the new shape.
- Applied common action pattern (`parseOrFail`, `requireUser`, `actionError/actionSuccess`) across appointment actions for consistent validation/auth/response flow.
- Renamed `appointment` and `appointment/comment` action files to short verb-based filenames (removed `*Action` suffix) while preserving exported function names.
- Reorganized appointment actions into domain folders (`create`, `list`, `detail`, `member`, `comment`) and renamed shared contracts file from `_shared.ts` to `types.ts`.
- Added appointment search card navigation to detail page and updated card meta UI to show host profile image + member icon/count.
- Added migration to extend `search_appointments_with_count` RPC with `host_profile_image` and mapped it in appointment search action/types.
- Updated dashboard group search card UI to show owner profile image + member icon/count.
- Connected group search `가입하기` button to `joinGroupAction` with cache update/invalidation and toast feedback.
- Added migration to extend `search_groups_with_count` RPC with `owner_profile_image` and mapped it in group search action/types.
- Added shared `PlainTopNav` component and consolidated duplicated plain-route top nav variants (detail/edit/place/members) into wrappers using the shared component.
- Removed duplicated top nav style files from appointment plain routes after consolidation.
- Refactored `DetailPageTopNav` to wrap shared `PlainTopNav` and removed duplicated `DetailPageTopNav.css.ts`.
- Removed `DetailPageTopNav` wrapper and switched profile edit page to use `PlainTopNav` directly.

## 2026-02-02 (late)
- Moved appointment routes from `(app)` to `(app-plain)` for step-based flow layout.
- Updated CONTEXT_ROUTES.md to reflect new route structure.

## 2026-02-02
- Added group onboarding flow pages and server actions.
- Added group RLS migration and middleware group gate for dashboard.
- Added Kakao map loader/hook/preview and place search action.
- Added appointment create/invite flow pages and actions.
- Added shared docs and tests for new actions.
- Limited appointment place result list height with internal scroll and left-aligned result cards.
- Moved appointment place map preview below search area, outside result cards.
- Split appointment create steps into separate components for each step.
- Added current location permission flow and distance-based place search input support.
- Added RLS policies for places/appointments/appointment_members to allow appointment creation flows.
- Added server-side logging for appointment creation failures to surface place/appointment errors.
- Moved appointment create group fetch to server page and introduced a client wrapper component to avoid double POST in dev.
- Moved app layout group fetch to server and passed groups into TopNav to avoid duplicate POSTs.
- Added Kakao map SDK preload in app layout to reduce first-map load latency.
- Cleared Kakao map container on updates to prevent previous map layers from overlapping.
- Moved appointment create data fetch into a route layout with context and made the page the UI entry point.
- Reused the existing Moveback component for appointment step navigation.
- Split appointment create step styles into per-step .css.ts files and slimmed page.css.ts.
- Restored place map preview rendering inside the place step after refactors.
- Reverted Moveback changes and reused its existing styles for the create step back button.
- Fixed onboarding signup router hook to use next/navigation in App Router.
- Added AI styling rules doc for Vanilla Extract and layout conventions.
- Added rules-by-example section to the styling guide.
- Refreshed context docs for appointments, Kakao, routes, session notes, and troubleshooting.
- Added Kakao map preview to the appointment confirm step.

## 2026-02-02 (docs)
- Added CONTEXT_SESSION/DB_RLS/ROUTES/TROUBLESHOOTING.
- Added update helper script and refreshed INDEX entries.
